# This workflow will build sdist & bdist of Python Package using manylinux container and
# upload them to PyPI using Twine when a release is created

name: PyPI Publish

on:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  container-build-dist:
    runs-on: ubuntu-latest
    container:
      image: quay.io/pypa/manylinux_2_28_x86_64
      options: --user root
      env:
        PLAT: manylinux_2_28_x86_64
      volumes:
      - $(pwd):/io

    steps:
    - name: check out repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        lfs: true

    - name: Build üêç distribution üì¶ in docker with CPython3.8
      run: |
        cd /io
        /opt/python/cp38-cp38/bin/python -m pip install build
        /opt/python/cp38-cp38/bin/python -m build
        auditwheel repair dist/*cp38-cp38-linux_x86_64.whl --plat ${PLAT}

    - name: Build üêç distribution üì¶ in docker with CPython3.9
      run: |
        cd /io
        /opt/python/cp39-cp39/bin/python -m pip install build
        /opt/python/cp39-cp39/bin/python -m build
        auditwheel repair dist/*cp39-cp39-linux_x86_64.whl --plat ${PLAT}

    - name: Check README rendering for PyPI
      run: |
        /opt/python/cp39-cp39/bin/python -m pip install twine
        /opt/python/cp39-cp39/bin/twine check dist/*


    - name: Upload wheel distribution as artifact
      uses: actions/upload-artifact@v3
      with:
        name: wheels
        path: ./wheelhouse/*.whl

    - name: Upload sdist distribution as artifact
      uses: actions/upload-artifact@v3
      with:
        name: sdist
        path: ./dist/*.tar.gz

    - name: Publish üêç distribution üì¶ to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        /opt/python/cp39-cp39/bin/twine upload dist/*-tar.gz
        /opt/python/cp39-cp39/bin/twine upload wheelhouse/*-manylinux*.whl
