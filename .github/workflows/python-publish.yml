# This workflow will build sdist & bdist of Python Package using manylinux container and
# upload them to PyPI using Twine when a release is created

name: PyPI Publish

on:
  workflow_dispatch:
  release:
    types: [published]

permissions:
  contents: read

jobs:
  build-dist:
    runs-on: ubuntu-latest

    steps:
    - name: Check out repo
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        lfs: true

    - name: Build 🐍 distribution 📦 in docker
      run: |
        docker run -v ${{ github.workspace }}:/io quay.io/pypa/manylinux_2_28_x86_64 /bin/bash /io/scripts/build_dist.sh

    - name: Set up Python 🐍 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9

    - name: Check README rendering for PyPI
      run: |
        python -m pip install twine --user
        twine check dist/*

    - name: Publish 🐍 distribution 📦 to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        twine upload dist/*-tar.gz
        twine upload wheelhouse/*-manylinux*.whl
